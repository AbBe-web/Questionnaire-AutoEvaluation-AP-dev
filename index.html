<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R√©sum√© de la pr√©-consultation d'activit√© physique</title>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f6f7f8;
  margin:0;
}

.container {
  max-width:720px;
  margin:40px auto;
  padding:30px;
  background:white;
  min-height:100vh;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.06);
}

h1,h2,h3 {
  font-weight:600;
  margin-top:25px;
}

/* =========================
   OPTION A ‚Äî MICRO UX VISUELLE
   ========================= */

/* Question principale */
p {
  margin-top:12px;
  margin-bottom:10px;
  line-height:1.5;
}

/* Premi√®re phrase = question ‚Üí plus visible */
p:first-of-type {
  font-weight:600;
}

/* Paragraphes explicatifs ‚Üí plus discrets */
p + p {
  font-weight:400;
  color:#555;
}

/* Espacement clair avant les boutons */
.btn {
  display: block;
  width: 100%;
  padding: 14px;
  margin: 14px 0 6px 0;
  font-size: 16px;
  border-radius: 10px;              /* plus doux */
  border: none;
  background: #2563eb;              /* bleu plus moderne */
  color: white;
  cursor: pointer;
  transition: all 0.15s ease;       /* animation fluide */
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.btn:hover {
  background: #1d4ed8;
  transform: translateY(-1px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.12);
}

.btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 4px rgba(0,0,0,0.08);
}

.btn.secondary {
  background: #e5e7eb;
  color: #333;
}

.btn.secondary:hover {
  background: #d1d5db;
}

.btn:disabled {
  background:#b0b0b0;
  cursor:not-allowed;
}

/* ========================= */

.section {
  border-top:1px solid #ddd;
  padding-top:15px;
  margin-top:20px;
}

.progress {
  height:8px;
  background:#e5e7eb;
  border-radius: 20px;
  overflow:hidden;
}

.progress-bar {
  height:8px;
  background: linear-gradient(90deg,#22c55e,#16a34a);
  border-radius: 20px;
  transition: width 0.3s ease;
}

.progress-step {
  font-size:12px;
  color:#777;
  margin-bottom:10px;
}
.footer {
  font-size:12px;
  color:#666;
  margin-top:40px;
}

.answer {
  margin-left:10px;
  margin-top:4px;
}

.rgpd {
  font-size:12px;
  color:#555;
  margin-top:8px;
}
input[type=number],
input[type=range],
textarea {
  width:100%;
  padding:12px;
  font-size:16px;
  border-radius:8px;
  border:1px solid #ddd;
  transition: border 0.2s ease;
}

input:focus,
textarea:focus {
  outline:none;
  border:1px solid #2563eb;
}

textarea {
  min-height:80px;
}

.time-row {
  display:flex;
  gap:10px;
}

.guard {
  font-size:13px;
  color:#d97706;
  margin-top:6px;
}

.back-info {
  font-size:12px;
  color:#666;
  margin-top:6px;
  text-align:center;
}
.copy-toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #323232;
  color: #fff;
  padding: 10px 18px;
  border-radius: 6px;
  font-size: 14px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  z-index: 9999;
}

.copy-toast.show {
  opacity: 1;
}

</style>
</head>

<body>
<div class="container" id="app"></div>

<script>
  
const app = document.getElementById("app");

if (!app) {
  console.error("Erreur critique : conteneur #app introuvable");
  throw new Error("App container missing");
}

/*************************************************
 * √âTAT GLOBAL
 *************************************************/
const state = {
  tool: null,
  gpaq: {},
  marshall: {},
  result: {},
  history: [],
  navStack: [],
  navMode: "forward",   // ‚¨ÖÔ∏è AJOUT ICI
  progress: {
    current: 0,
    total: 0
  }
};

const savedNav = sessionStorage.getItem("nav_stack");
if (savedNav) {
  try {
    const parsed = JSON.parse(savedNav);

    // üîí S√©curit√© DSR :
    // un navStack < 2 est inutilisable pour le back ‚Üí on le neutralise
    if (Array.isArray(parsed) && parsed.length >= 2) {
      state.navStack = parsed;
    } else {
      state.navStack = [];
      sessionStorage.removeItem("nav_stack");
    }

  } catch (e) {
    state.navStack = [];
    sessionStorage.removeItem("nav_stack");
  }
}

/*************************************************
 * RENDER + RETOUR
 *************************************************/
function render(html, progress = 0) {
  try {

    const percent =
      state.progress.total > 0
        ? Math.round(
            (state.progress.current / state.progress.total) * 100
          )
        : 0;

    app.innerHTML = `
      <div class="progress">
        <div class="progress-bar" style="width:${percent}%"></div>
      </div>
      <div class="progress-step">
        √âtape ${state.progress.current} / ${state.progress.total}
      </div>
      ${html}
    `;

  } catch (e) {
    console.error("Erreur render()", e);
    app.innerHTML = `
      <p>Une erreur est survenue.
      Veuillez recharger la page.</p>
    `;
  }
}

function pushScreen(screenId) {

  if (state.navMode === "back") {
    return; // ‚õîÔ∏è on n‚Äôempile pas pendant un retour
  }

  if (!screenId || typeof screenId !== "string") {
    console.warn("screenId invalide :", screenId);
    return;
  }

  const last = state.navStack[state.navStack.length - 1];

  if (last !== screenId) {
    state.navStack.push(screenId);

    sessionStorage.setItem(
      "nav_stack",
      JSON.stringify(state.navStack)
    );
  }
}

function goToScreen(id) {
  const map = {

    // --- MARSHALL ---
   "MAR-Q1": marshallQ1,
    "MAR-Q2": marshallQ2,

    "MAR-STAGE1": motivation,
    "MAR-STAGE2": motivation2,
    
    "MAR-STEPS": stepsQuestion,

    "MAR-EVA-IMP": evaImportance,
    "MAR-EVA-IMP-REASONS": evaImportanceComment,
    "MAR-EVA-CONF": evaConfiance,
    "MAR-EVA-CONF-REASONS": evaConfianceComment,

    "MAR-THANKS": endTransition,
    "MAR-SUMMARY": final,

    // --- GPAQ ---
    "GPAQ-INTRO": gpaqIntro,

    "GPAQ-Q1": gpaqQ1,
    "GPAQ-Q2": gpaqQ2,
    "GPAQ-Q4": gpaqQ4,
    "GPAQ-Q5": gpaqQ5,
    "GPAQ-INTRO-TRANSPORT": gpaqIntroTransport,
    "GPAQ-Q7": gpaqQ7,
    "GPAQ-Q8": gpaqQ8,
    "GPAQ-Q10": gpaqQ10,
    "GPAQ-Q11": gpaqQ11,
    "GPAQ-Q13": gpaqQ13,
    "GPAQ-Q14": gpaqQ14,
    "GPAQ-INTRO-SED": gpaqIntroSedentaire,
    "GPAQ-Q16": gpaqQ16,

"GPAQ-STEPS": stepsQuestion,

"GPAQ-STAGE1": motivation,
"GPAQ-STAGE2": motivation2,


    "GPAQ-EVA-IMP": evaImportance,
    "GPAQ-EVA-IMP-REASONS": evaImportanceComment,
    "GPAQ-EVA-CONF": evaConfiance,
    "GPAQ-EVA-CONF-REASONS": evaConfianceComment,
    
    "GPAQ-THANKS": endTransition,
    "GPAQ-SUMMARY": final,
  };

  if (map[id]) {
    map[id]();
  } else {
    console.warn("√âcran non mapp√© :", id);
  }
}

function back() {

  if (state.navStack && state.navStack.length > 1) {

    state.navStack.pop();

    sessionStorage.setItem(
      "nav_stack",
      JSON.stringify(state.navStack)
    );

    const target = state.navStack[state.navStack.length - 1];

if (!target) {
  console.warn("NavStack invalide ‚Üí retour s√©curis√© accueil");
  renderHome();
  return;
}

state.navMode = "back";   // ‚¨ÖÔ∏è on passe en mode retour

app.innerHTML = "";

goToScreen(target);

state.navMode = "forward"; // ‚¨ÖÔ∏è on r√©active mode normal

return;

  }

  if (state.navStack && state.navStack.length === 1) {
    renderHome();
    return;
  }
}

function safeBack(){

  // Cas normal : navigation d√©clarative disponible
  if (state.navStack && state.navStack.length > 1) {
    back();
    return;
  }

  // Garde-fou s√©curis√© :
  // on NE touche PAS au DOM avant render()
  final();
}

/*************************************************
 * UX ‚Äî UTILITAIRES (NON CLINIQUES)
 *************************************************/
function checkRequiredDuration(btnId, daySel, hSel, mSel){
  const btn = document.getElementById(btnId);
  if(!btn) return;

  const d = document.querySelector(daySel)?.value;
  const h = document.querySelector(hSel)?.value;
  const m = document.querySelector(mSel)?.value;

  const hasDay = d !== "";
  const hasTime = (h !== "" && Number(h) > 0) || (m !== "" && Number(m) > 0);

  btn.disabled = !(hasDay && hasTime);
}

function checkRequiredTimeOnly(btnId, hSel, mSel){
  const btn = document.getElementById(btnId);
  if(!btn) return;

  const h = document.querySelector(hSel)?.value;
  const m = document.querySelector(mSel)?.value;

  btn.disabled = (h === "" && m === "");
}
function checkDurationGuard(hSel, mSel, guardId){
  const h = Number(document.querySelector(hSel)?.value || 0);
  const m = Number(document.querySelector(mSel)?.value || 0);
  const guard = document.getElementById(guardId);
  if(!guard) return;
  guard.style.display = (h + m/60) > 12 ? "block" : "none";
}
function advanceProgress(points){
  state.progress.current += points;
  if(state.progress.current > state.progress.total){
    state.progress.current = state.progress.total;
  }
}
/*************************************************
 * ACCUEIL
 *************************************************/
function renderHome() {

  // üîí Sortie propre du parcours
  state.navStack = [];
  sessionStorage.removeItem("nav_stack");

  render(`
    <h1>Activit√© physique</h1>
    <p>Questionnaire destin√© √† pr√©parer votre consultation m√©dicale.<br>
    Aucune donn√©e n‚Äôest enregistr√©e.</p>

    <div class="rgpd">
      <a href="https://abbe-web.github.io/Questionnaire-AutoEvaluation-AP/politique-confidentialite.html" target="_blank">
        Politique de confidentialit√©
      </a>
    </div>

    <button class="btn" onclick="start('gpaq')">Questionnaire d√©taill√© (GPAQ)</button>
    <button class="btn secondary" onclick="start('marshall')">Questionnaire court (Marshall)</button>
  `, 0, null); // ‚ö†Ô∏è pas de screenId
}


function start(tool){
  state.tool = tool;

  // üîí DSR ‚Äî reset navigation d√©clarative au d√©marrage d‚Äôun parcours
  state.navStack = [];
  sessionStorage.removeItem("nav_stack");

  state.gpaq = {};
  state.marshall = {};
  state.result = {};

  state.progress.current = 0;
  state.progress.total = (tool === "marshall") ? 8 : 12;

  tool==="marshall" ? marshallQ1() : gpaqIntro();
}

/*************************************************
 * GPAQ ‚Äî INTRODUCTION G√âN√âRALE OMS
 *************************************************/
function gpaqIntro(){
pushScreen("GPAQ-INTRO");
  render(`
<h2>Questionnaire GPAQ ‚Äì Organisation mondiale de la Sant√©</h2>

<p>
Je vais maintenant vous poser quelques questions sur le temps que vous consacrez √† diff√©rents types d‚Äôactivit√© physique lors d'une semaine typique.
Veuillez r√©pondre √† ces questions m√™me si vous ne vous consid√©rez pas comme quelqu‚Äôun d‚Äôactif.
</p>

<p>
Pensez tout d‚Äôabord au temps que vous y consacrez au travail, qu'il s'agisse d'un travail r√©mun√©r√© ou non, de t√¢ches m√©nag√®res,
de cueillir ou r√©colter des aliments, de p√™cher ou chasser, de chercher un emploi.
</p>

<p>
Dans les questions suivantes, les activit√©s physiques de forte intensit√© sont des activit√©s n√©cessitant un effort physique important
et causant une augmentation cons√©quente de la respiration ou du rythme cardiaque, et les activit√©s physiques d'intensit√© mod√©r√©e sont
des activit√©s qui demandent un effort physique mod√©r√© et causant une petite augmentation de la respiration ou du rythme cardiaque.
</p>

<button class="btn" onclick="gpaqQ1()">Commencer le questionnaire</button>
<button class="btn secondary" onclick="back()">Retour</button>
`,5);
}

/*************************************************
 * MARSHALL
 *************************************************/
function marshallQ1(){
pushScreen("MAR-Q1");
render(`
<h2>Marshall ‚Äì Question 1</h2>
<p>Au cours d‚Äôune semaine habituelle, combien de fois pratiquez-vous une activit√© physique intense d‚Äôau moins 20 minutes ?</p>
<button class="btn" onclick="state.marshall.q1=4; advanceProgress(1); marshallQ2()">‚â• 3 fois / semaine</button>
<button class="btn" onclick="state.marshall.q1=2; advanceProgress(1); marshallQ2()">1‚Äì2 fois / semaine</button>
<button class="btn" onclick="state.marshall.q1=0; advanceProgress(1); marshallQ2()">Jamais</button>
<button class="btn secondary" onclick="back()">Retour</button>
<div class="back-info">Les r√©ponses d√©j√† saisies sont conserv√©es pour le calcul final.</div>
`,15);
}

function marshallQ2(){
pushScreen("MAR-Q2");
  render(`
<h2>Marshall ‚Äì Question 2</h2>
<p>Combien de fois par semaine pratiquez-vous une activit√© physique mod√©r√©e ou de la marche rapide pendant au moins 30 minutes ?</p>
<button class="btn" onclick="advanceProgress(1); finishMarshall(4)">‚â• 5 fois / semaine</button>
<button class="btn" onclick="advanceProgress(1); finishMarshall(2)">3‚Äì4 fois / semaine</button>
<button class="btn" onclick="advanceProgress(1); finishMarshall(1)">1‚Äì2 fois / semaine</button>
<button class="btn" onclick="advanceProgress(1); finishMarshall(0)">Jamais</button>
<button class="btn secondary" onclick="back()">Retour</button>
<div class="back-info">Les r√©ponses d√©j√† saisies sont conserv√©es pour le calcul final.</div>
`,30);
}

function finishMarshall(q2){
  state.marshall.q2=q2;
  const score=state.marshall.q1+q2;
  state.result.niveau = score>=4 ? "suffisamment_actif" : "insuffisamment_actif";
  state.result.marshall_score=score;
  stepsQuestion();
}

/*************************************************
 * GPAQ ‚Äî FLUX COMPLET
 *************************************************/
function gpaqQ1(){
  pushScreen("GPAQ-Q1");
  render(`
<h2>Activit√© au travail ‚Äì intensit√© √©lev√©e</h2>
<p>Est-ce que votre travail implique des activit√©s physiques de forte intensit√© qui n√©cessitent une augmentation cons√©quente de la respiration ou du rythme cardiaque, comme soulever des charges lourdes, travailler sur un chantier, effectuer du travail de ma√ßonnerie, pendant au moins 10 minutes d‚Äôaffil√©e ?</p>
<button class="btn" onclick="state.gpaq.wi=1; gpaqQ2()">Oui</button>
<button class="btn" onclick="state.gpaq.wi=0; gpaqQ4()">Non</button>
<button class="btn secondary" onclick="back()">Retour</button>
<div class="back-info">Les r√©ponses d√©j√† saisies sont conserv√©es pour le calcul final.</div>
`,10);
}

function gpaqQ2(){
pushScreen("GPAQ-Q2");
  render(`
<h2>Activit√© au travail ‚Äì intensit√© √©lev√©e</h2>
<p>Lors d‚Äôune journ√©e habituelle durant laquelle vous effectuez des activit√©s physiques de forte intensit√©, combien de temps consacrez-vous √† ces activit√©s ?</p>

<input type="number" id="d1" min="0" max="7"
placeholder="Nombre de jours par semaine (ex. : 3)"
oninput="state.gpaq.wi_d=this.value; checkRequiredDuration('c1','#d1','#h1','#m1')">

<p>Combien de temps par jour ?</p>
<div class="time-row">
<input type="number" id="h1" min="0" max="23" placeholder="Heures"
oninput="state.gpaq.wi_h=this.value; checkRequiredDuration('c1','#d1','#h1','#m1'); checkDurationGuard('#h1','#m1','g1')">
<input type="number" id="m1" min="0" max="59" placeholder="Minutes"
oninput="state.gpaq.wi_m=this.value; checkRequiredDuration('c1','#d1','#h1','#m1'); checkDurationGuard('#h1','#m1','g1')">
</div>

<div id="g1" class="guard" style="display:none;">
‚ö†Ô∏è V√©rifiez votre saisie (dur√©e inhabituelle)
</div>

<button class="btn" id="c1" disabled onclick="gpaqQ4()">Continuer</button>
<button class="btn secondary" onclick="back()">Retour</button>
<div class="back-info">Les r√©ponses d√©j√† saisies sont conserv√©es pour le calcul final.</div>
`,20);
}

function gpaqQ4(){
advanceProgress(1); // fin bloc "travail intense"
 pushScreen("GPAQ-Q4");
  render(`
<h2>Activit√© au travail ‚Äì intensit√© mod√©r√©e</h2>
<p>Est-ce que votre travail implique des activit√©s physiques d'intensit√© mod√©r√©e, comme une marche rapide ou soulever une charge l√©g√®re, durant au moins 10 minutes d‚Äôaffil√©e ?</p>
<button class="btn" onclick="state.gpaq.wm=1; gpaqQ5()">Oui</button>
<button class="btn" onclick="state.gpaq.wm=0; gpaqIntroTransport()">Non</button>
<button class="btn secondary" onclick="back()">Retour</button>
<div class="back-info">Les r√©ponses d√©j√† saisies sont conserv√©es pour le calcul final.</div>
`,30);
}

function gpaqQ5(){
pushScreen("GPAQ-Q5");
  render(`
<h2>Activit√© au travail ‚Äì intensit√© mod√©r√©e</h2>
<p>Habituellement, combien de jours par semaine effectuez-vous des activit√©s physiques d'intensit√© mod√©r√©e dans le cadre de votre travail ?</p>

<input type="number" id="d2" min="0" max="7"
placeholder="Nombre de jours par semaine (ex. : 3)"
oninput="state.gpaq.wm_d=this.value; checkRequiredDuration('c2','#d2','#h2','#m2')">

<p>Lors d‚Äôune journ√©e habituelle durant laquelle vous effectuez des activit√©s physiques d'intensit√© mod√©r√©e, combien de temps consacrez-vous √† ces activit√©s ?</p>
<div class="time-row">
<input type="number" id="h2" min="0" max="23" placeholder="Heures"
oninput="state.gpaq.wm_h=this.value; checkRequiredDuration('c2','#d2','#h2','#m2'); checkDurationGuard('#h2','#m2','g2')">
<input type="number" id="m2" min="0" max="59" placeholder="Minutes"
oninput="state.gpaq.wm_m=this.value; checkRequiredDuration('c2','#d2','#h2','#m2'); checkDurationGuard('#h2','#m2','g2')">
</div>

<div id="g2" class="guard" style="display:none;">
‚ö†Ô∏è V√©rifiez votre saisie (dur√©e inhabituelle)
</div>

<button class="btn" id="c2" disabled onclick="gpaqIntroTransport()">Continuer</button>
<button class="btn secondary" onclick="back()">Retour</button>
<div class="back-info">Les r√©ponses d√©j√† saisies sont conserv√©es pour le calcul final.</div>
`,40);
}

/*************************************************
 * GPAQ ‚Äî INTRO D√âPLACEMENTS (OMS)
 *************************************************/
function gpaqIntroTransport(){
 advanceProgress(1); // fin bloc "travail mod√©r√©"
  pushScreen("GPAQ-INTRO-TRANSPORT");
  render(`
<h2>D√©placements</h2>

<p>
Les questions suivantes excluent les activit√©s physiques dans le cadre de votre travail, que vous avez d√©j√† mentionn√©es.
</p>

<p>
Maintenant, je voudrais conna√Ætre votre fa√ßon habituelle de vous d√©placer d'un endroit √† l'autre ; par exemple pour aller au travail,
faire des courses, aller au march√©, aller √† votre lieu consacr√© au culte.
</p>

<button class="btn" onclick="gpaqQ7()">Continuer</button>
<button class="btn secondary" onclick="back()">Retour</button>
<div class="back-info">Les r√©ponses d√©j√† saisies sont conserv√©es pour le calcul final.</div>
`,45);
}

function gpaqQ7(){
pushScreen("GPAQ-Q7");
  render(`
<h2>D√©placements</h2>
<p>Effectuez-vous des trajets d‚Äôau moins 10 minutes √† pied ou √† v√©lo ?</p>
<button class="btn" onclick="state.gpaq.tr=1; gpaqQ8()">Oui</button>
<button class="btn" onclick="state.gpaq.tr=0; gpaqQ10()">Non</button>
<button class="btn secondary" onclick="back()">Retour</button>
<div class="back-info">Les r√©ponses d√©j√† saisies sont conserv√©es pour le calcul final.</div>
`,50);
}

function gpaqQ8(){
pushScreen("GPAQ-Q8");
  render(`
<h2>D√©placements</h2>

<p>Habituellement, combien de jours par semaine effectuez-vous des trajets d‚Äôau moins 10 minutes √† pied ou √† v√©lo ?</p>
<input type="number" id="d3" min="0" max="7"
placeholder="Nombre de jours par semaine (ex. : 3)"
oninput="state.gpaq.tr_d=this.value; checkRequiredDuration('c3','#d3','#h3','#m3')">

<p>Lors d‚Äôune journ√©e habituelle, combien de temps consacrez-vous √† vos d√©placements √† pied ou √† v√©lo ?</p>
<div class="time-row">
<input type="number" id="h3" min="0" max="23" placeholder="Heures"
oninput="state.gpaq.tr_h=this.value; checkRequiredDuration('c3','#d3','#h3','#m3'); checkDurationGuard('#h3','#m3','g3')">
<input type="number" id="m3" min="0" max="59" placeholder="Minutes"
oninput="state.gpaq.tr_m=this.value; checkRequiredDuration('c3','#d3','#h3','#m3'); checkDurationGuard('#h3','#m3','g3')">
</div>

<div id="g3" class="guard" style="display:none;">
‚ö†Ô∏è V√©rifiez votre saisie (dur√©e inhabituelle)
</div>

<button class="btn" id="c3" disabled onclick="gpaqQ10()">Continuer</button>
<button class="btn secondary" onclick="back()">Retour</button>
<div class="back-info">Les r√©ponses d√©j√† saisies sont conserv√©es pour le calcul final.</div>
`,60);
}

function gpaqQ10(){
advanceProgress(1); // fin bloc "d√©placements"
  pushScreen("GPAQ-Q10");
  render(`
<h2>Loisirs ‚Äì activit√© intense</h2>
<p>Est-ce que vous pratiquez des sports, du fitness ou des activit√©s de loisirs de forte intensit√© qui n√©cessitent une augmentation importante de la respiration ou du rythme cardiaque comme [courir ou jouer au football] pendant au moins dix minutes d'affil√©e ?</p>
<button class="btn" onclick="state.gpaq.li=1; gpaqQ11()">Oui</button>
<button class="btn" onclick="state.gpaq.li=0; gpaqQ13()">Non</button>
<button class="btn secondary" onclick="back()">Retour</button>
<div class="back-info">Les r√©ponses d√©j√† saisies sont conserv√©es pour le calcul final.</div>
`,70);
}

function gpaqQ11(){
pushScreen("GPAQ-Q11");
  render(`
<h2>Loisirs ‚Äì activit√© intense</h2>

<p>Habituellement, combien de jours par semaine pratiquez-vous une activit√© sportive, du fitness ou d'autres activit√©s de loisirs de forte intensit√© ?</p>
<input type="number" id="d4" min="0" max="7"
placeholder="Nombre de jours par semaine (ex. : 3)"
oninput="state.gpaq.li_d=this.value; checkRequiredDuration('c4','#d4','#h4','#m4')">

<p>Lors d‚Äôune journ√©e habituelle, combien de temps y consacrez-vous ?</p>
<div class="time-row">
<input type="number" id="h4" min="0" max="23" placeholder="Heures"
oninput="state.gpaq.li_h=this.value; checkRequiredDuration('c4','#d4','#h4','#m4'); checkDurationGuard('#h4','#m4','g4')">
<input type="number" id="m4" min="0" max="59" placeholder="Minutes"
oninput="state.gpaq.li_m=this.value; checkRequiredDuration('c4','#d4','#h4','#m4'); checkDurationGuard('#h4','#m4','g4')">
</div>

<div id="g4" class="guard" style="display:none;">
‚ö†Ô∏è V√©rifiez votre saisie (dur√©e inhabituelle)
</div>

<button class="btn" id="c4" disabled onclick="gpaqQ13()">Continuer</button>
<button class="btn secondary" onclick="back()">Retour</button>
<div class="back-info">Les r√©ponses d√©j√† saisies sont conserv√©es pour le calcul final.</div>
`,75);
}

function gpaqQ13(){
 advanceProgress(1); // fin bloc "loisirs intenses"
 pushScreen("GPAQ-Q13");
  render(`
<h2>Loisirs ‚Äì activit√© mod√©r√©e</h2>
<p>Est-ce que vous pratiquez des sports, du fitness ou des activit√©s de loisirs d'intensit√© mod√©r√©e qui n√©cessitent une petite augmentation de la respiration ou du rythme cardiaque comme la marche rapide, faire du v√©lo, nager, jouer au volley, pendant au moins dix minutes d'affil√©e ?</p>
<button class="btn" onclick="state.gpaq.lm=1; gpaqQ14()">Oui</button>
<button class="btn" onclick="state.gpaq.lm=0; gpaqIntroSedentaire()">Non</button>
<button class="btn secondary" onclick="back()">Retour</button>
<div class="back-info">Les r√©ponses d√©j√† saisies sont conserv√©es pour le calcul final.</div>
`,80);
}

function gpaqQ14(){
pushScreen("GPAQ-Q14");
  render(`
<h2>Loisirs ‚Äì activit√© mod√©r√©e</h2>

<p>Habituellement, combien de jours par semaine pratiquez-vous une activit√© sportive, du fitness ou d'autres activit√©s de loisirs d'intensit√© mod√©r√©e ?</p>
<input type="number" id="d5" min="0" max="7"
placeholder="Nombre de jours par semaine (ex. : 3)"
oninput="state.gpaq.lm_d=this.value; checkRequiredDuration('c5','#d5','#h5','#m5')">

<p>Lors d‚Äôune journ√©e habituelle, combien de temps y consacrez-vous ?</p>
<div class="time-row">
<input type="number" id="h5" min="0" max="23" placeholder="Heures"
oninput="state.gpaq.lm_h=this.value; checkRequiredDuration('c5','#d5','#h5','#m5'); checkDurationGuard('#h5','#m5','g5')">
<input type="number" id="m5" min="0" max="59" placeholder="Minutes"
oninput="state.gpaq.lm_m=this.value; checkRequiredDuration('c5','#d5','#h5','#m5'); checkDurationGuard('#h5','#m5','g5')">
</div>

<div id="g5" class="guard" style="display:none;">
‚ö†Ô∏è V√©rifiez votre saisie (dur√©e inhabituelle)
</div>

<button class="btn" id="c5" disabled onclick="gpaqIntroSedentaire()">Continuer</button>
<button class="btn secondary" onclick="back()">Retour</button>
<div class="back-info">Les r√©ponses d√©j√† saisies sont conserv√©es pour le calcul final.</div>
`,85);
}

/*************************************************
 * GPAQ ‚Äî INTRO COMPORTEMENT S√âDENTAIRE (OMS)
 *************************************************/
function gpaqIntroSedentaire(){
advanceProgress(1); // fin bloc "loisirs mod√©r√©s"
 pushScreen("GPAQ-INTRO-SED");
  render(`
<h2>Comportement s√©dentaire</h2>

<p>
La question suivante concerne le temps pass√© en position assise ou couch√©e, au travail, √† la maison, en d√©placement,
√† rendre visite √† des amis, et inclut le temps pass√© assis devant un bureau, se d√©placer en voiture, en bus, en train,
√† lire, jouer aux cartes ou √† regarder la t√©l√©vision,
mais n'inclut pas le temps pass√© √† dormir.
</p>

<button class="btn" onclick="gpaqQ16()">Continuer</button>
<button class="btn secondary" onclick="back()">Retour</button>
<div class="back-info">Les r√©ponses d√©j√† saisies sont conserv√©es pour le calcul final.</div>
`,88);
}
function gpaqQ16(){
pushScreen("GPAQ-Q16");
  render(`
<h2>Comportement s√©dentaire</h2>

<p>Combien de temps passez-vous assis ou couch√© par jour (hors sommeil) lors d'une journ√©e habituelle ?</p>
<div class="time-row">
<input type="number" id="h6" min="0" max="23" placeholder="Heures"
oninput="state.gpaq.sed_h=this.value; checkRequiredTimeOnly('c6','#h6','#m6'); checkDurationGuard('#h6','#m6','g6')">
<input type="number" id="m6" min="0" max="59" placeholder="Minutes"
oninput="state.gpaq.sed_m=this.value; checkRequiredTimeOnly('c6','#h6','#m6'); checkDurationGuard('#h6','#m6','g6')">
</div>

<div id="g6" class="guard" style="display:none;">
‚ö†Ô∏è V√©rifiez votre saisie (dur√©e inhabituelle)
</div>

<button class="btn" id="c6" disabled onclick="finishGPAQ()">Terminer</button>
<button class="btn secondary" onclick="back()">Retour</button>
<div class="back-info">Les r√©ponses d√©j√† saisies sont conserv√©es pour le calcul final.</div>
`,90);
}

function minutes(h,m){ return (Number(h||0)*60)+Number(m||0); }

function finishGPAQ(){
  advanceProgress(1); // s√©dentarit√© = 1 point

  const wi = (state.gpaq.wi_d||0)*minutes(state.gpaq.wi_h,state.gpaq.wi_m);
  const wm = (state.gpaq.wm_d||0)*minutes(state.gpaq.wm_h,state.gpaq.wm_m);
  const tr = (state.gpaq.tr_d||0)*minutes(state.gpaq.tr_h,state.gpaq.tr_m);
  const li = (state.gpaq.li_d||0)*minutes(state.gpaq.li_h,state.gpaq.li_m);
  const lm = (state.gpaq.lm_d||0)*minutes(state.gpaq.lm_h,state.gpaq.lm_m);

  const MET = wi*8 + li*8 + (wm+tr+lm)*4;
  state.result.met = MET;

  if(MET>=3000) state.result.niveau="tr√®s_actif";
  else if(MET>=600) state.result.niveau="moyennement_actif";
  else state.result.niveau="insuffisamment_actif";

  stepsQuestion();
}
  
function stepsQuestion(){
 pushScreen(
  state.tool === "marshall"
    ? "MAR-STEPS"
    : "GPAQ-STEPS"
);
render(`
<h2>Activit√© quotidienne (facultatif)</h2>

<p>
Si vous suivez votre nombre de pas, indiquez votre moyenne sur le dernier mois.
</p>

<input type="number" min="0" placeholder="Ex. : 6500"
oninput="state.result.pas_mois=this.value">

<button class="btn" onclick="motivation()">Continuer</button>
<button class="btn secondary" onclick="back()">Retour</button>
`, 94);
}

/*************************************************
 * MOTIVATION + EVA
 *************************************************/
function motivation(){

  pushScreen(
    state.tool === "marshall"
      ? "MAR-STAGE1"
      : "GPAQ-STAGE1"
  );

  const niveau = state.result?.niveau;

  // üîí S√©curit√© passive (jamais de back automatique)
  if (!niveau) {
    console.warn("Niveau manquant ‚Üí affichage s√©curis√©");

    render(`
      <h2>Motivation</h2>
      <p>Une erreur inattendue est survenue.</p>
      <button class="btn secondary" onclick="back()">Retour</button>
    `);

    return;
  }

  // üîπ Cas insuffisamment actif
  if(niveau === "insuffisamment_actif"){

    render(`
      <h2>Motivation</h2>
      <p>Envisagez-vous d‚Äôaugmenter votre activit√© physique dans les 30 jours ?</p>

      <button class="btn" onclick="
        advanceProgress(2);
        state.result.stade='pr√©paration';
        evaImportance();
      ">Oui</button>

      <button class="btn" onclick="motivation2()">Non</button>

      <button class="btn secondary" onclick="back()">Retour</button>

      <div class="back-info">
        Les r√©ponses d√©j√† saisies sont conserv√©es pour le calcul final.
      </div>
    `,95);

  } else {

    // üîπ Cas suffisamment / tr√®s actif
    render(`
      <h2>Motivation</h2>
      <p>√ätes-vous actif √† ce niveau depuis plus de 6 mois ?</p>

      <button class="btn" onclick="
        advanceProgress(2);
        state.result.stade='consolidation';
        evaImportance();
      ">Oui</button>

      <button class="btn" onclick="
        advanceProgress(2);
        state.result.stade='action';
        evaImportance();
      ">Non</button>

      <button class="btn secondary" onclick="back()">Retour</button>

      <div class="back-info">
        Les r√©ponses d√©j√† saisies sont conserv√©es pour le calcul final.
      </div>
    `,95);
  }
}

function motivation2(){
pushScreen(
  state.tool === "marshall"
    ? "MAR-STAGE2"
    : "GPAQ-STAGE2"
  );
  render(`
<h2>Motivation</h2>
<p>Avez-vous l‚Äôintention de vous engager dans une activit√© physique r√©guli√®re dans les 6 mois ?</p>
<button class="btn" onclick="advanceProgress(2); state.result.stade='intention'; evaImportance()">Oui</button>
<button class="btn" onclick="advanceProgress(2); state.result.stade='ind√©termination'; evaImportance()">Non</button>
<button class="btn secondary" onclick="back()">Retour</button>
<div class="back-info">Les r√©ponses d√©j√† saisies sont conserv√©es pour le calcul final.</div>
`,96);
}

function evaImportance(){
pushScreen(
  state.tool === "marshall"
      ? "MAR-EVA-IMP"
      : "GPAQ-EVA-IMP"
    );
  render(`
<h2>Importance de l‚Äôactivit√© physique</h2>
<p>Quelle importance accordez-vous √† l‚Äôactivit√© physique dans votre vie ?</p>
<input type="range" min="0" max="10" value="5"
oninput="this.nextElementSibling.innerText=this.value">
<div>5</div>
<button class="btn" onclick="
advanceProgress(1);
state.result.importance=document.querySelector('input').value;
evaImportanceComment();
">Continuer</button>
<button class="btn secondary" onclick="back()">Retour</button>
<div class="back-info">Les r√©ponses d√©j√† saisies sont conserv√©es pour le calcul final.</div>
`,97);
}

function evaImportanceComment(){
pushScreen(
  state.tool === "marshall"
    ? "MAR-EVA-IMP-REASONS"
    : "GPAQ-EVA-IMP-REASONS"
);
  render(`
<h2>Votre choix</h2>
<p>
Pouvez-vous m‚Äôindiquer en quelques mots pour quelles raisons vous avez choisi ce chiffre ?<br>
<em>Sinon, passez √† la question suivante.</em>
</p>
<textarea placeholder="Votre r√©ponse (facultative)"
onchange="state.result.importance_comment=this.value"></textarea>
<button class="btn" onclick="advanceProgress(1); evaConfiance()">Continuer</button>
<button class="btn secondary" onclick="back()">Retour</button>
<div class="back-info">Les r√©ponses d√©j√† saisies sont conserv√©es pour le calcul final.</div>
`,98);
}

function evaConfiance(){
  const question = state.result.niveau==="insuffisamment_actif"
    ? "Dans quelle mesure √™tes-vous confiant(e) en vous pour r√©ussir √† augmenter votre niveau d‚Äôactivit√© physique ?"
    : "Dans quelle mesure √™tes-vous confiant(e) en vous pour r√©ussir √† maintenir voire augmenter votre niveau d‚Äôactivit√© physique ?";
pushScreen(
  state.tool === "marshall"
  ? "MAR-EVA-CONF"
  : "GPAQ-EVA-CONF"
);
  render(`
<h2>Confiance en soi</h2>
<p>${question}</p>
<input type="range" min="0" max="10" value="5"
oninput="this.nextElementSibling.innerText=this.value">
<div>5</div>
<button class="btn" onclick="
advanceProgress(1);
state.result.confiance=document.querySelector('input').value;
evaConfianceComment();
">Continuer</button>
<button class="btn secondary" onclick="back()">Retour</button>
<div class="back-info">Les r√©ponses d√©j√† saisies sont conserv√©es pour le calcul final.</div>
`,99);
}

function evaConfianceComment(){
pushScreen(
  state.tool === "marshall"
    ? "MAR-EVA-CONF-REASONS"
    : "GPAQ-EVA-CONF-REASONS"
);
  render(`
<h2>Votre r√©ponse</h2>
<p>
Pouvez-vous m‚Äôindiquer en quelques mots ce qui vous rend confiant(e) ou, au contraire, ce qui vous freine ?<br>
<em>Sinon, passez √† la question suivante.</em>
</p>
<textarea placeholder="Votre r√©ponse (facultative)"
onchange="state.result.confiance_comment=this.value"></textarea>
<button class="btn" onclick="advanceProgress(1); endTransition()">Terminer</button>
<button class="btn secondary" onclick="back()">Retour</button>
<div class="back-info">Les r√©ponses d√©j√† saisies sont conserv√©es pour le calcul final.</div>
`,99);
}
  
function endTransition(){
pushScreen(
  state.tool === "marshall"
    ? "MAR-THANKS"
    : "GPAQ-THANKS"
  );
  render(`
<h2>Merci</h2>
<p>Vos r√©ponses ont bien √©t√© prises en compte.</p>

<p>
Vous allez maintenant voir un r√©sum√© √† apporter √† votre consultation.
</p>

<button class="btn" onclick="final()">Voir mon r√©sum√©</button>
<button class="btn secondary" onclick="back()">Retour</button>
`,99);
}

function buildExportJSON(){
  return {
    meta: {
      outil: "preconsultation-activite-physique",
      version: "v0.x",
      date: new Date().toISOString(),
      questionnaires: state.tool === "gpaq" ? "GPAQ" : "Marshall",
      donnees_enregistrees: false
    },

    questionnaires: {
      marshall: state.marshall,

      gpaq: {
        travail: {
          intense: {
            oui_non: state.gpaq.wi ?? null,
            jours_par_semaine: state.gpaq.wi_d ?? null,
            heures_par_jour: state.gpaq.wi_h ?? null,
            minutes_par_jour: state.gpaq.wi_m ?? null
          },
          moderee: {
            oui_non: state.gpaq.wm ?? null,
            jours_par_semaine: state.gpaq.wm_d ?? null,
            heures_par_jour: state.gpaq.wm_h ?? null,
            minutes_par_jour: state.gpaq.wm_m ?? null
          }
        },

        deplacements: {
          oui_non: state.gpaq.tr ?? null,
          jours_par_semaine: state.gpaq.tr_d ?? null,
          heures_par_jour: state.gpaq.tr_h ?? null,
          minutes_par_jour: state.gpaq.tr_m ?? null
        },

        loisirs: {
          intense: {
            oui_non: state.gpaq.li ?? null,
            jours_par_semaine: state.gpaq.li_d ?? null,
            heures_par_jour: state.gpaq.li_h ?? null,
            minutes_par_jour: state.gpaq.li_m ?? null
          },
          moderee: {
            oui_non: state.gpaq.lm ?? null,
            jours_par_semaine: state.gpaq.lm_d ?? null,
            heures_par_jour: state.gpaq.lm_h ?? null,
            minutes_par_jour: state.gpaq.lm_m ?? null
          }
        },

        sedentarite: {
          heures_par_jour: state.gpaq.sed_h ?? null,
          minutes_par_jour: state.gpaq.sed_m ?? null
        }
      }
    },

    resultats: {
  met_minutes_semaine: state.result.met ?? null,
  niveau_activite: state.result.niveau ?? null,
  pas_moyens_jour_1_mois: state.result.pas_mois ?? null
},

    motivation: {
      stade: state.result.stade ?? null,
      importance_eva_0_10: state.result.importance ?? null,
      importance_commentaire: state.result.importance_comment ?? null,
      confiance_eva_0_10: state.result.confiance ?? null,
      confiance_commentaire: state.result.confiance_comment ?? null
    }
  };
}

function freezeExportJSON() {
  const frozen = buildExportJSON();

  state.exportJSON = frozen;

  sessionStorage.setItem(
    "preconsultation_final",
    JSON.stringify(frozen)
  );

  return frozen;
}

function openPrintable() {
  const frozen = freezeExportJSON();

  const json = encodeURIComponent(
    JSON.stringify(frozen)
  );

  window.open(
    "print.html?data=" + json,
    "_blank"
  );
}


// üîê Copie de secours (utilis√©e si partage / mail √©choue)
// üîê Copie de secours (utilis√©e si partage / mail √©choue)
function copyFallback(text) {
  if (!navigator.clipboard || !navigator.clipboard.writeText) {
    console.warn("Clipboard indisponible");
    return;
  }

  navigator.clipboard.writeText(text)
    .catch(() => {
      console.warn("Copie de secours impossible");
    });
}

function shareToDoctor() {
  const frozen = freezeExportJSON();

  if (!frozen) {
    alert("Donn√©es indisponibles.");
    return;
  }

  const mailTitle = "Auto-√©valuation de l‚Äôactivit√© physique ‚Äì consultation m√©dicale";

  const dataBlock =
`--- D√âBUT DES DONN√âES ---
${JSON.stringify(frozen, null, 2)}
--- FIN DES DONN√âES ---`;

  const mailBody =
`Bonjour,

Vous trouverez ci-dessous les informations issues de mon questionnaire
d‚Äôauto-√©valuation de l‚Äôactivit√© physique, rempli en amont de la consultation.

Ces donn√©es peuvent √™tre copi√©es et int√©gr√©es dans votre compte-rendu m√©dical.

${dataBlock}`;

  const subject = encodeURIComponent(mailTitle);
  const body = encodeURIComponent(mailBody);

  /* üì± Mobile ‚Üí partage natif */
  const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

  if (isMobile && navigator.share) {
    navigator.share({
      title: mailTitle,
      text: mailTitle + "\n\n" + mailBody
    }).catch(() => {
      copyFallback(mailTitle + "\n\n" + mailBody);
    });
    return;
  }

  /* üñ•Ô∏è PC ‚Üí client mail par d√©faut (Outlook / Exchange) */
  window.location.href = `mailto:?subject=${subject}&body=${body}`;

/* Aide explicite pour les webmails */
setTimeout(() => {
  alert(
    "Si aucun nouveau message ne s‚Äôest ouvert automatiquement, " +
    "les donn√©es ont √©t√© copi√©es.\n\n" +
    "Vous pouvez les coller manuellement dans un email √† destination de votre m√©decin."
  );
}, 500);

/* Copie syst√©matique de secours */
copyFallback(mailTitle + "\n\n" + mailBody);
}
  
function final(){

  state.exportJSON = buildExportJSON();

  sessionStorage.setItem(
    "preconsultation_final",
    JSON.stringify(state.exportJSON)
  );

  console.log("EXPORT JSON", state.exportJSON);
  
pushScreen(
   state.tool === "marshall"
    ? "MAR-SUMMARY"
    : state.tool === "gpaq"
      ? "GPAQ-SUMMARY"
      : null
  );
render(`
<h2>R√©sultat</h2>

<p>
  <strong>Niveau d‚Äôactivit√© :</strong>
  ${state.result.niveau ? state.result.niveau.replace("_"," ") : "non disponible"}
  ${state.result.met ? ` (${state.result.met} MET-min/semaine)` : ""}
</p>

${state.result.pas_mois ? `
<div class="section">
  <strong>Nombre de pas moyen (1 mois)</strong>
  <div class="answer">${state.result.pas_mois} pas / jour</div>
</div>
` : ""}

<div class="section">
  <strong>Stade motivationnel</strong>
  <div class="answer">${state.result.stade ?? "non renseign√©"}</div>
</div>

<div class="section">
  <strong>Importance de l'activit√© physique</strong>
  <div class="answer">
    ${state.result.importance != null ? state.result.importance + "/10" : "non renseign√©e"}
  </div>
</div>

<div class="section">
  <strong>Confiance pour augmenter ou maintenir son activit√© physique</strong>
  <div class="answer">
    ${state.result.confiance != null ? state.result.confiance + "/10" : "non renseign√©e"}
  </div>
</div>

<button class="btn" onclick="openPrintable()">Voir mon bilan d'activit√© physique</button>
<button class="btn secondary" onclick="restart()">Recommencer</button>
<button class="btn secondary" onclick="safeBack()">Retour</button>

<p class="footer">
  Document √† apporter lors de votre consultation m√©dicale.
</p>
`, 100);
}

function restart() {
  sessionStorage.removeItem("preconsultation_final");
  location.reload();
}

window.addEventListener("load", () => {
  const saved = sessionStorage.getItem("preconsultation_final");

  if (saved) {
    try {
    const parsed = JSON.parse(saved);

if (
  !parsed ||
  typeof parsed !== "object" ||
  !parsed.resultats ||
  !parsed.motivation
) {
  throw new Error("Export JSON invalide");
}

state.exportJSON = parsed;
      
state.tool = parsed.meta.questionnaires === "GPAQ"
  ? "gpaq"
  : "marshall";

      state.result = {
  niveau: state.exportJSON.resultats?.niveau_activite ?? null,
  met: state.exportJSON.resultats?.met_minutes_semaine ?? null,
  pas_mois: state.exportJSON.resultats?.pas_moyens_jour_1_mois ?? null,
  stade: state.exportJSON.motivation?.stade ?? null,
  importance: state.exportJSON.motivation?.importance_eva_0_10 ?? null,
  confiance: state.exportJSON.motivation?.confiance_eva_0_10 ?? null
};

      final();
      return; // ‚õîÔ∏è emp√™che le render accueil

    } catch (e) {
      console.warn("Erreur restauration session :", e);
      sessionStorage.removeItem("preconsultation_final");
     
      renderHome();
      return;  
    }
  }

  /* fallback s√ªr */
  renderHome();
});

function showCopyToast() {
  const toast = document.getElementById("copy-toast");
  if (!toast) return;

  toast.classList.add("show");

  setTimeout(() => {
    toast.classList.remove("show");
  }, 2000);
}

function copyContent() {
  const data = state.exportJSON || buildExportJSON();
  if (!data) {
    console.warn("Aucune donn√©e √† copier");
    return;
  }

  let output = "";

  // Titre global
  output += "R√âSUM√â DE LA PR√â-CONSULTATION D‚ÄôACTIVIT√â PHYSIQUE\n\n";

  // 1. Synth√®se
  output += "1. SYNTH√àSE\n\n";

  const niveau = data.resultats.niveau_activite
    ? data.resultats.niveau_activite.replace("_", " ")
    : "non disponible";

  output += "NIVEAU D‚ÄôACTIVIT√â PHYSIQUE :\n";
  output += niveau + "\n";

  if (data.resultats.met_minutes_semaine !== null) {
    output += `Volume estim√© : ${data.resultats.met_minutes_semaine} MET-min / semaine\n`;
  }

  output += "\n";

  output += "STADE MOTIVATIONNEL :\n";
  output += (data.motivation.stade ?? "non renseign√©") + "\n\n";

  output += "IMPORTANCE DE L‚ÄôACTIVIT√â PHYSIQUE :\n";
  output += (data.motivation.importance_eva_0_10 ?? "‚Äì") + " / 10\n\n";

  output += "CONFIANCE :\n";
  output += (data.motivation.confiance_eva_0_10 ?? "‚Äì") + " / 10\n\n";

  // 2. Questionnaire
  if (data.meta.questionnaires === "Marshall") {
    output += "2. QUESTIONNAIRE MARSHALL\n";
    const score =
      (data.questionnaires.marshall.q1 || 0) +
      (data.questionnaires.marshall.q2 || 0);
    output += "Score total : " + score + "\n";
  }

  if (data.meta.questionnaires === "GPAQ") {
    output += "2. QUESTIONNAIRE GPAQ\n";
  }

 navigator.clipboard.writeText(output)
  .catch(() => {
    console.warn("Copie impossible");
  });

// Feedback utilisateur imm√©diat (ind√©pendant du navigateur)
showCopyToast();

}

</script>
  <div id="copy-toast" class="copy-toast">
  R√©sum√© copi√© ‚úî
</div>

</body>
</html>
